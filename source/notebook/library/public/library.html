<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" type="text/css" href="./css/common.css?cachelib=false">
    <link rel="stylesheet" type="text/css" href="./css/tooltip.css?cachelib=false">
    <link rel="stylesheet" type="text/css" href="./css/library.css?cachelib=false">

    <script src="./js/knockout-3.5.1.js?cachelib=false"></script>
    <script src="./js/maptool.js?cachelib=false"></script>
</head>

<body>
    <h1>Available Notebooks</h1>
    <ul id="booksList" data-bind="foreach: books">

        <li>
            <button class="button" data-bind="id: bookId, attr: {title:summary}, click: $parent.openBook">
                <p class="accent" data-bind="style: accent, text: title"></p>
                <img src="./images/key.png" width="16" height="16" data-bind="title: owner, hidden: private">
            </button>
        </li>
    </ul>

    <div style="position:fixed;left:5px;bottom:5px;">
        <input id="frame" type="checkbox" data-bind="checked: asFrame, event: { change: checkChanged }" />
        <label for="frame">Open as frame</label>
    </div>

    <script>
        (async () => {
            const rawdata = await MT.getUserData();

            function BookInfo(bookData) {
                let self = this;

                self.title = decodeURIComponent(bookData.title);
                self.summary = decodeURIComponent(bookData.summary);
                self.accent = "--accent-bg: " + bookData.accent;
                self.owner = bookData.owner;
                self.private = bookData.private;

                self.data = bookData;
            }

            function LibraryViewModel() {
                let self = this;

                try {
                    let userData = JSON.parse(atob(rawdata));

                    let bookArray = userData.notebooks.map(x => new BookInfo(x));
                    self.books = ko.observableArray(bookArray);
                    self.asFrame = ko.observable(userData.asFrame);

                    self.checkChanged = async function() {
                        await MT.setLibProperty("asFrame", self.asFrame() ? 1 : 0);
                    };

                    self.openBook = async function(book) {
                        await MT.showBook('show', btoa(JSON.stringify(book.data)), self.asFrame());
                    };

                } catch (error) {
                    console.log(error);
                }
            }
            ko.applyBindings(new LibraryViewModel());
        })();
    </script>
</body>

</html>