<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="./notebook.css?cachelib=false">
    <script defer src="./notebook.js?cachelib=false"></script>
</head>

<body>
    <div id="overlay">
        <div id="main">
            <div data-tooltip="Open library">
                <img id="quill" src="./images/quill-paper.png?cachelib=false" onclick="evaluateMacro('[h:js.showLibrary()]');">
            </div>
        </div>
        <div id="options">
            <div data-tooltip="Add new book">
                <img id="add" src="./images/add.png?cachelib=false" onclick="evaluateMacro('[h:js.editBook()]');">
            </div>
            <div data-tooltip="About MapTool Notebooks">
                <img id="about" src="./images/question.png?cachelib=false" onclick="evaluateMacro('[h:js.showAbout()]');">
            </div>
        </div>
    </div>
    
    <script>
        // https://javascript.info/mouse-drag-and-drop
        let isDragging = false;

        document.addEventListener('mousedown', function (event) {
            let coords;
            let shiftX;
            let shiftY;
            let dragElement = event.target.closest('#overlay');

            if (!dragElement) {
                return;
            }
            
            event.preventDefault();

            dragElement.ondragstart = function () {
                return false;
            };

            startDrag(dragElement, event.clientX, event.clientY);

            function onMouseUp(event) {
                finishDrag();
            };

            function onMouseMove(event) {
                moveAt(event.clientX, event.clientY);
            }

            function startDrag(element, clientX, clientY) {
                if (isDragging) {
                    return;
                }

                isDragging = true;

                document.addEventListener('mousemove', onMouseMove);
                element.addEventListener('mouseup', onMouseUp);

                shiftX = clientX - element.getBoundingClientRect().left;
                shiftY = clientY - element.getBoundingClientRect().top;

                element.style.position = 'fixed';

                moveAt(clientX, clientY);
            };

            function finishDrag() {
                if (!isDragging) {
                    return;
                }

                isDragging = false;

                dragElement.style.top = parseInt(dragElement.style.top) + window.pageYOffset + 'px';
                dragElement.style.position = 'absolute';

                document.removeEventListener('mousemove', onMouseMove);
                dragElement.removeEventListener('mouseup', onMouseUp);
            }

            function moveAt(clientX, clientY) {
                let newX = clientX - shiftX;
                let newY = clientY - shiftY;

                let newBottom = newY + dragElement.offsetHeight;

                if (newBottom > document.documentElement.clientHeight) {
                    let docBottom = document.documentElement.getBoundingClientRect().bottom;
                    let scrollY = Math.min(docBottom - newBottom, 10);

                    if (scrollY < 0) scrollY = 0;

                    window.scrollBy(0, scrollY);

                    newY = Math.min(newY, document.documentElement.clientHeight - dragElement.offsetHeight);
                }

                if (newY < 0) {
                    let scrollY = Math.min(-newY, 10);
                    if (scrollY < 0) scrollY = 0;

                    window.scrollBy(0, -scrollY);
                    newY = Math.max(newY, 0); // newY may not be below 0
                }

                if (newX < 0) newX = 0;
                if (newX > document.documentElement.clientWidth - dragElement.offsetWidth) {
                    newX = document.documentElement.clientWidth - dragElement.offsetWidth;
                }

                dragElement.style.left = newX + 'px';
                dragElement.style.top = newY + 'px';
            }
        });
    </script>
</body>

</html>